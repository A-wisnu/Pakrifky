{
  "name": "Masjid AI Workflow - Replit Ready",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook-masjid",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "1",
      "name": "📱 WhatsApp Gateway",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 400]
    },
    {
      "parameters": {
        "functionCode": "// 🚀 SMART MESSAGE PROCESSOR FOR REPLIT\nconst moment = require('moment');\n\n// Configuration optimized for Replit\nconst CONFIG = {\n  apis: {\n    openrouter: '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',\n    supabase_url: 'https://bvaxxlmhrzocbrqiykoqul.supabase.co',\n    supabase_key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2YXh4bG1ocnpvY2JycWl5a29xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NjMxMDMsImV4cCI6MjA2OTQzOTEwM30.GjDhx8BUR7Y4FUS2PZalEeDhKVt_zQWGTEV_5nKKgrg'\n  },\n  ai_models: {\n    primary: 'moonshotai/kimi-k2:free',\n    fallback: 'google/gemma-7b-it:free'\n  }\n};\n\n// Masjid Information\nconst MASJID = {\n  info: {\n    nama: 'Masjid Al-Ikhlas',\n    alamat: 'Jl. Raya Masjid No. 123, Jakarta Selatan 12345',\n    whatsapp: '+62-812-3456-7890',\n    email: 'info@masjidalukhlas.id',\n    website: 'https://masjidalukhlas.id',\n    established: '15 Maret 1985',\n    capacity: 2000\n  },\n  \n  rekening: {\n    banks: {\n      bca: { no: '1234567890', name: 'Masjid Al-Ikhlas' },\n      mandiri: { no: '0987654321', name: 'Yayasan Masjid Al-Ikhlas' },\n      bri: { no: '5555666677778888', name: 'Takmir Masjid Al-Ikhlas' }\n    },\n    ewallet: {\n      dana: '081234567890',\n      gopay: '081234567890',\n      ovo: '081234567890',\n      shopeepay: '081234567890'\n    },\n    qris: 'https://replit.com/@yourname/qris-masjid.png'\n  },\n  \n  ustadz: [\n    {\n      nama: 'Ustadz Dr. Ahmad Dahlan, Lc., M.A',\n      spesialisasi: ['Fiqh Ibadah', 'Akhlaq & Tasawuf', 'Tafsir Al-Quran'],\n      jadwal: 'Senin-Kamis 19:00-21:00, Jumat 08:00-11:00',\n      kontak: '+62-813-1111-2222',\n      email: 'ahmad@masjidalukhlas.id'\n    },\n    {\n      nama: 'Ustadz Muhammad Ridwan, S.H.I., M.E.I',\n      spesialisasi: ['Ekonomi Syariah', 'Hukum Keluarga', 'Parenting Islami'],\n      jadwal: 'Selasa-Jumat 08:00-12:00, Sabtu 19:00-21:00',\n      kontak: '+62-813-3333-4444',\n      email: 'ridwan@masjidalukhlas.id'\n    },\n    {\n      nama: 'Ustadzah Dr. Aisyah Mahmud, Lc., M.Pd',\n      spesialisasi: ['Konsultasi Wanita', 'Pendidikan Anak', 'Psikologi Islam'],\n      jadwal: 'Rabu-Jumat 14:00-17:00 (Khusus wanita)',\n      kontak: '+62-814-4444-5555',\n      email: 'aisyah@masjidalukhlas.id'\n    }\n  ]\n};\n\n// Prayer Times Calculator\nfunction getPrayerTimes() {\n  const now = moment();\n  const times = {\n    fajr: '04:30',\n    sunrise: '05:45', \n    dhuhr: '12:15',\n    asr: '15:30',\n    maghrib: '18:45',\n    isha: '20:00'\n  };\n  \n  const currentHour = now.hour();\n  const currentMinute = now.minute();\n  const currentTime = currentHour * 60 + currentMinute;\n  \n  const prayerMinutes = {\n    fajr: 4 * 60 + 30,\n    dhuhr: 12 * 60 + 15,\n    asr: 15 * 60 + 30,\n    maghrib: 18 * 60 + 45,\n    isha: 20 * 60 + 0\n  };\n  \n  let nextPrayer = 'Subuh';\n  let nextTime = '04:30';\n  let countdown = '';\n  \n  for (const [prayer, minutes] of Object.entries(prayerMinutes)) {\n    if (currentTime < minutes) {\n      nextPrayer = prayer === 'fajr' ? 'Subuh' : \n                   prayer === 'dhuhr' ? 'Dzuhur' :\n                   prayer === 'asr' ? 'Ashar' :\n                   prayer === 'maghrib' ? 'Magrib' : 'Isya';\n      nextTime = times[prayer];\n      const remaining = minutes - currentTime;\n      const hours = Math.floor(remaining / 60);\n      const mins = remaining % 60;\n      countdown = `${hours}h ${mins}m`;\n      break;\n    }\n  }\n  \n  return { times, nextPrayer, nextTime, countdown };\n}\n\n// Intent Classification (Health services removed)\nfunction classifyIntent(message) {\n  const msg = message.toLowerCase();\n  const time = moment();\n  const hour = time.hour();\n  const day = time.day();\n  \n  const intents = {\n    // Spiritual Services\n    jadwal_shalat: {\n      keywords: ['jadwal shalat', 'waktu shalat', 'adzan', 'subuh', 'dzuhur', 'ashar', 'magrib', 'isya'],\n      score: hour >= 4 && hour <= 20 ? 10 : 7\n    },\n    kiblat_direction: {\n      keywords: ['kiblat', 'qibla', 'arah shalat', 'direction', 'compass'],\n      score: 8\n    },\n    doa_harian: {\n      keywords: ['doa', 'dzikir', 'wirid', 'tasbih', 'istighfar'],\n      score: 9\n    },\n    ayat_quran: {\n      keywords: ['ayat', 'quran', 'alquran', 'surah', 'verse'],\n      score: 9\n    },\n    hadits_nabi: {\n      keywords: ['hadits', 'hadith', 'sunnah', 'nabi', 'rasul'],\n      score: 8\n    },\n    \n    // Educational Services\n    kajian_pengajian: {\n      keywords: ['kajian', 'pengajian', 'ceramah', 'ustadz', 'belajar islam'],\n      score: day === 5 ? 10 : 7\n    },\n    tpq_tahfidz: {\n      keywords: ['tpq', 'tahfidz', 'mengaji', 'belajar quran', 'hafalan'],\n      score: 8\n    },\n    konsultasi_syariah: {\n      keywords: ['konsultasi', 'tanya ustadz', 'fatwa', 'hukum islam', 'syariah'],\n      score: 9\n    },\n    \n    // Community Services\n    donasi_infaq: {\n      keywords: ['donasi', 'infaq', 'sedekah', 'zakat', 'transfer', 'rekening'],\n      score: 8\n    },\n    program_sosial: {\n      keywords: ['sosial', 'bantuan', 'dhuafa', 'yatim', 'fakir miskin'],\n      score: 7\n    },\n    layanan_jenazah: {\n      keywords: ['jenazah', 'meninggal', 'kafan', 'pemakaman', 'tahlil'],\n      score: 10\n    },\n    \n    // Information Services\n    info_masjid: {\n      keywords: ['info', 'alamat', 'lokasi', 'kontak', 'fasilitas'],\n      score: 6\n    },\n    live_streaming: {\n      keywords: ['live', 'streaming', 'online', 'youtube', 'broadcast'],\n      score: hour >= 11 && hour <= 13 ? 8 : 6\n    },\n    \n    // AI Chat\n    ai_chat_islamic: {\n      keywords: ['tanya', 'bagaimana', 'kenapa', 'apa itu', 'jelaskan'],\n      score: 6\n    },\n    \n    // Greeting\n    salam_greeting: {\n      keywords: ['assalamualaikum', 'salam', 'halo', 'hai'],\n      score: 6\n    }\n  };\n  \n  let bestMatch = { intent: 'ai_chat_islamic', score: 0 };\n  \n  for (const [intent, config] of Object.entries(intents)) {\n    const matches = config.keywords.filter(keyword => msg.includes(keyword)).length;\n    const totalScore = matches * config.score;\n    \n    if (totalScore > bestMatch.score) {\n      bestMatch = { intent, score: totalScore, confidence: Math.min(totalScore / 10, 1) };\n    }\n  }\n  \n  return bestMatch;\n}\n\n// Message Parser for multi-provider\nfunction parseMessage(body) {\n  let phone, message, messageType, timestamp;\n  \n  if (body.entry && body.entry[0]?.changes?.[0]?.value?.messages) {\n    const msg = body.entry[0].changes[0].value.messages[0];\n    phone = msg.from;\n    messageType = msg.type;\n    message = msg.text?.body || `[${messageType}]`;\n    timestamp = msg.timestamp;\n  } else if (body.device && body.message) {\n    phone = body.device;\n    message = body.message;\n    messageType = body.message_type || 'text';\n    timestamp = body.date;\n  } else if (body.from && body.body) {\n    phone = body.from;\n    message = body.body;\n    messageType = body.type || 'text';\n    timestamp = body.timestamp;\n  } else if (body.phone && body.message) {\n    phone = body.phone;\n    message = body.message;\n    messageType = body.type || 'text';\n    timestamp = body.timestamp || Date.now();\n  }\n  \n  return { phone, message, messageType, timestamp };\n}\n\n// Clean phone number\nfunction cleanPhone(phone) {\n  if (!phone) return null;\n  phone = phone.replace(/[^0-9+]/g, '');\n  if (phone.startsWith('0')) phone = '+62' + phone.substring(1);\n  else if (phone.startsWith('62')) phone = '+' + phone;\n  else if (!phone.startsWith('+')) phone = '+62' + phone;\n  return phone;\n}\n\n// Main Processing\nconst startTime = Date.now();\nconst body = $input.all()[0].body;\n\nconst parsed = parseMessage(body);\nlet { phone, message, messageType, timestamp } = parsed;\n\nphone = cleanPhone(phone);\n\nif (!phone || !message) {\n  return [{\n    json: {\n      error: 'Invalid input',\n      hasError: true,\n      phone: phone || 'unknown',\n      message: message || 'empty'\n    }\n  }];\n}\n\nconst classification = classifyIntent(message);\nconst prayerData = getPrayerTimes();\n\nreturn [{\n  json: {\n    phone: phone,\n    message: message,\n    messageType: messageType,\n    timestamp: timestamp || new Date().toISOString(),\n    intent: classification.intent,\n    confidence: classification.confidence,\n    score: classification.score,\n    prayer_data: prayerData,\n    current_time: moment().format('HH:mm'),\n    current_date: moment().format('DD/MM/YYYY'),\n    day_name: moment().format('dddd'),\n    is_friday: moment().day() === 5,\n    processing_time: Date.now() - startTime,\n    hasError: false,\n    config: CONFIG,\n    masjid: MASJID\n  }\n}];"
      },
      "id": "2",
      "name": "🧠 Smart Processor",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.intent }}",
              "operation": "equal",
              "value2": "ai_chat_islamic"
            }
          ]
        }
      },
      "id": "3",
      "name": "🤖 Need AI?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [700, 400]
    },
    {
      "parameters": {
        "functionCode": "// 🤖 AI CHAT ENGINE FOR REPLIT\nconst data = $input.all()[0].json;\n\nasync function generateAIResponse(message, context) {\n  const systemPrompt = `Anda adalah AI Assistant Masjid ${context.masjid.info.nama}, asisten cerdas untuk umat Islam.\n\nKARAKTER:\n- Berpengetahuan Islam (Al-Quran, Hadits, Fiqh)\n- Bijaksana, sabar, dan empati\n- Bahasa Indonesia mudah dipahami\n- Sopan dan santun\n- Jawaban praktis dan aplikatif\n\nKONTEKS:\n- Hari: ${context.day_name}\n- Waktu: ${context.current_time} WIB\n- Shalat selanjutnya: ${context.prayer_data.nextPrayer}\n\nMASJID INFO:\n- Nama: ${context.masjid.info.nama}\n- Alamat: ${context.masjid.info.alamat}\n- WhatsApp: ${context.masjid.info.whatsapp}\n\nUSTADZ:\n${context.masjid.ustadz.map(u => `- ${u.nama} (${u.spesialisasi.join(', ')})`).join('\\n')}\n\nPEDOMAN:\n✅ Gunakan emoji relevan\n✅ Jawaban terstruktur\n✅ Sertakan dalil jika ada\n✅ Rujuk ustadz untuk masalah kompleks\n❌ Jangan berfatwa tanpa dasar\n❌ Hindari politik/SARA`;\n\n  try {\n    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${context.config.apis.openrouter}`,\n        'Content-Type': 'application/json',\n        'HTTP-Referer': 'https://replit.com',\n        'X-Title': 'Masjid AI Replit'\n      },\n      body: JSON.stringify({\n        model: context.config.ai_models.primary,\n        messages: [\n          { role: 'system', content: systemPrompt },\n          { role: 'user', content: message }\n        ],\n        max_tokens: 1000,\n        temperature: 0.7\n      })\n    });\n    \n    if (response.ok) {\n      const result = await response.json();\n      let aiResponse = result.choices[0].message.content;\n      \n      if (!aiResponse.includes('🤲') && !aiResponse.includes('السلام')) {\n        aiResponse = '🤲 ' + aiResponse;\n      }\n      \n      aiResponse += `\\n\\n💡 **Menu Lainnya:**\\n• \"jadwal shalat\" - Waktu shalat\\n• \"donasi\" - Info rekening\\n• \"kajian\" - Jadwal pengajian\\n• \"info\" - Tentang masjid`;\n      \n      return {\n        response: aiResponse,\n        model_used: context.config.ai_models.primary,\n        tokens: result.usage?.total_tokens || 0,\n        status: 'success'\n      };\n    } else {\n      throw new Error('AI API Error');\n    }\n  } catch (error) {\n    return {\n      response: `🤖 Maaf, sistem AI sedang gangguan. \\n\\nUntuk bantuan:\\n👨‍🏫 ${context.masjid.ustadz[0].nama}: ${context.masjid.ustadz[0].kontak}\\n📱 Admin: ${context.masjid.info.whatsapp}\\n\\n🔄 Coba lagi nanti.`,\n      model_used: 'fallback',\n      tokens: 0,\n      status: 'error'\n    };\n  }\n}\n\nconst result = await generateAIResponse(data.message, data);\n\nreturn [{\n  json: {\n    ...data,\n    response: result.response,\n    ai_model: result.model_used,\n    ai_tokens: result.tokens,\n    ai_status: result.status,\n    response_type: 'AI_GENERATED'\n  }\n}];"
      },
      "id": "4",
      "name": "🤖 AI Engine",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [950, 300]
    },
    {
      "parameters": {
        "functionCode": "// 📋 SERVICE TEMPLATES (Health services removed)\nconst data = $input.all()[0].json;\nconst moment = require('moment');\n\nconst serviceTemplates = {\n  jadwal_shalat: () => {\n    const prayerData = data.prayer_data;\n    const now = moment();\n    const times = prayerData.times;\n    \n    return `🕌 *JADWAL SHALAT HARI INI*\\n📅 ${now.format('dddd, DD MMMM YYYY')}\\n📍 ${data.masjid.info.nama}\\n\\n🌅 **Subuh:** ${times.fajr} WIB\\n🌄 **Terbit:** ${times.sunrise} WIB\\n☀️ **Dzuhur:** ${times.dhuhr} WIB\\n🌤️ **Ashar:** ${times.asr} WIB\\n🌅 **Magrib:** ${times.maghrib} WIB\\n🌙 **Isya:** ${times.isha} WIB\\n\\n⏰ **Shalat Selanjutnya:** ${prayerData.nextPrayer}\\n🕐 **Waktu:** ${prayerData.nextTime} WIB\\n${prayerData.countdown ? `⏳ **Countdown:** ${prayerData.countdown}\\n` : ''}\\n🕋 **Arah Kiblat:** 294° dari Utara\\n📍 **Lokasi:** ${data.masjid.info.alamat}\\n\\n🤲 *\"Aqiimu ash-shalata li dhikrii\"*\\n*\"Dirikanlah shalat untuk mengingat-Ku\"* (QS. Thaha: 14)`;\n  },\n  \n  kiblat_direction: () => `🧭 *ARAH KIBLAT*\\n📍 ${data.masjid.info.nama}\\n\\n🕋 **Arah Kiblat:** 294° dari Utara (Barat Laut)\\n🧭 Gunakan kompas atau aplikasi kiblat\\n\\n📱 **Aplikasi Kiblat:**\\n• Muslim Pro\\n• Qibla Compass\\n• Adzan Prayer Times\\n\\n🕌 **Tips:**\\n1. Gunakan kompas akurat\\n2. Hindari gangguan magnetik\\n3. Konfirmasi dengan aplikasi\\n4. Ikuti jamaah masjid\\n\\n🤲 *\"Wa lillahi al-mashriqu wal-maghrib\"*\\n*\"Milik Allah-lah timur dan barat\"* (QS. Al-Baqarah: 115)`,\n  \n  doa_harian: () => `🤲 *DOA & DZIKIR HARIAN*\\n\\n🌅 **DOA PAGI:**\\n*أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ*\\n*Ashbahnaa wa ashbahal mulku lillaah*\\n*\"Kami memasuki pagi dan kerajaan milik Allah\"*\\n\\n📿 **DZIKIR SETELAH SHALAT:**\\n*سُبْحَانَ اللَّهِ* (33x)\\n*الْحَمْدُ لِلَّهِ* (33x)\\n*اللَّهُ أَكْبَرُ* (34x)\\n\\n🌙 **DOA SORE:**\\n*أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ*\\n*Amsaynaa wa amsal mulku lillaah*\\n\\n🔄 **ISTIGHFAR:**\\n*أَسْتَغْفِرُ اللَّهَ الْعَظِيمَ* (100x)\\n\\n📖 **Sumber:** HR. Bukhari & Muslim`,\n  \n  ayat_quran: () => `📖 *AYAT AL-QURAN PILIHAN*\\n\\n🌟 **QS. Al-Baqarah: 255 (Ayat Kursi)**\\n*اللَّهُ لَا إِلَهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ*\\n*\"Allah, tidak ada Tuhan selain Dia Yang Hidup kekal...\"*\\n\\n🌟 **QS. Al-Ikhlas (1-4)**\\n*قُلْ هُوَ اللَّهُ أَحَدٌ*\\n*\"Katakanlah: Dia-lah Allah, Yang Maha Esa\"*\\n\\n🌟 **QS. Al-Falaq & An-Nas**\\n📿 Mu'awwidzatain (Dua surah pelindung)`,\n  \n  hadits_nabi: () => `☪️ *HADITS RASULULLAH SAW*\\n\\n🌟 **Hadits Akhlak:**\\n*\"إِنَّمَا بُعِثْتُ لِأُتَمِّمَ صَالِحَ الْأَخْلَاقِ\"*\\n*\"Aku diutus untuk menyempurnakan akhlak baik\"* (HR. Ahmad)\\n\\n🌟 **Hadits Ilmu:**\\n*\"مَنْ سَلَكَ طَرِيقًا يَلْتَمِسُ فِيهِ عِلْمًا سَهَّلَ اللَّهُ لَهُ طَرِيقًا إِلَى الْجَنَّةِ\"*\\n*\"Barangsiapa menempuh jalan menuntut ilmu, Allah mudahkan jalan ke surga\"* (HR. Muslim)\\n\\n🌟 **Hadits Sedekah:**\\n*\"الصَّدَقَةُ تُطْفِئُ الْخَطِيئَةَ كَمَا يُطْفِئُ الْمَاءُ النَّارَ\"*\\n*\"Sedekah menghapus dosa seperti air memadamkan api\"* (HR. Tirmidzi)`,\n  \n  kajian_pengajian: () => {\n    const ustadz = data.masjid.ustadz;\n    return `📚 *JADWAL KAJIAN & PENGAJIAN*\\n📍 ${data.masjid.info.nama}\\n\\n📖 **KAJIAN RUTIN MINGGUAN**\\n\\n🟢 **AHAD - Kajian Keluarga**\\n🕘 09:00-11:00 WIB\\n👨‍🏫 ${ustadz[0].nama}\\n📚 Fiqh Keluarga & Parenting\\n👥 Keluarga (Free)\\n\\n🔵 **SENIN - Tafsir Al-Quran**\\n🕕 19:30-21:00 WIB\\n👨‍🏫 ${ustadz[0].nama}\\n📚 Tafsir Surah Pilihan\\n👥 Umum (Free)\\n\\n🟡 **RABU - Fiqh Muamalah**\\n🕗 20:00-21:30 WIB\\n👨‍🏫 ${ustadz[1].nama}\\n📚 Ekonomi Islam\\n👥 Umum (Free)\\n\\n🟣 **JUMAT - Kultum**\\n🕐 12:30-13:00 WIB\\n👨‍🏫 Ustadz Tamu\\n📚 Tema Aktual\\n👥 Jamaah Jumat\\n\\n🔴 **SABTU - Kajian Wanita**\\n🕘 09:00-11:00 WIB\\n👩‍🏫 ${ustadz[2].nama}\\n📚 Fiqh Wanita\\n👥 Khusus Wanita\\n\\n📞 **Info:** ${data.masjid.info.whatsapp}`;\n  },\n  \n  tpq_tahfidz: () => `📚 *PENDIDIKAN QURAN*\\n📍 ${data.masjid.info.nama}\\n\\n👶 **TPQ (Taman Pendidikan Quran)**\\n📅 Selasa-Jumat: 15:00-17:00\\n👥 Usia: 4-12 tahun\\n💰 Rp 150.000/bulan\\n📖 Iqro 1-6, Juz Amma\\n\\n🎓 **TAHFIDZ AL-QURAN**\\n📅 Senin-Kamis: 16:00-18:00\\n👥 Usia: 10+ tahun\\n💰 Rp 200.000/bulan\\n🎯 Target: 1 Juz/6 bulan\\n\\n👨‍🏫 **Pengajar:**\\n• Hafidz 30 juz\\n• Metode modern\\n• Berpengalaman\\n\\n📞 **Daftar:** ${data.masjid.info.whatsapp}`,\n  \n  konsultasi_syariah: () => {\n    const ustadz = data.masjid.ustadz;\n    return `🤲 *KONSULTASI SYARIAH*\\n📍 ${data.masjid.info.nama}\\n\\n👨‍🏫 **TIM USTADZ**\\n\\n🟢 **${ustadz[0].nama}**\\n📚 ${ustadz[0].spesialisasi.join(', ')}\\n⏰ ${ustadz[0].jadwal}\\n📱 ${ustadz[0].kontak}\\n\\n🔵 **${ustadz[1].nama}**\\n📚 ${ustadz[1].spesialisasi.join(', ')}\\n⏰ ${ustadz[1].jadwal}\\n📱 ${ustadz[1].kontak}\\n\\n🟡 **${ustadz[2].nama}**\\n📚 ${ustadz[2].spesialisasi.join(', ')}\\n⏰ ${ustadz[2].jadwal}\\n📱 ${ustadz[2].kontak}\\n\\n📋 **KATEGORI:**\\n💒 Pernikahan & Keluarga\\n💰 Ekonomi Syariah\\n👶 Parenting Islami\\n🎓 Pendidikan\\n\\n📱 **METODE:**\\n🏢 Tatap muka\\n📞 WhatsApp/Call\\n💻 Video call\\n📧 Email\\n\\n💰 **GRATIS** (Donasi sukarela)`;\n  },\n  \n  donasi_infaq: () => {\n    const banks = data.masjid.rekening.banks;\n    const ewallet = data.masjid.rekening.ewallet;\n    return `💰 *DONASI & ZAKAT*\\n📍 ${data.masjid.info.nama}\\n\\n🏦 **REKENING BANK**\\n\\n💳 **BCA:** ${banks.bca.no}\\na.n. ${banks.bca.name}\\n\\n💳 **Mandiri:** ${banks.mandiri.no}\\na.n. ${banks.mandiri.name}\\n\\n💳 **BRI:** ${banks.bri.no}\\na.n. ${banks.bri.name}\\n\\n📱 **E-WALLET**\\n💰 **DANA:** ${ewallet.dana}\\n💰 **GoPay:** ${ewallet.gopay}\\n💰 **OVO:** ${ewallet.ovo}\\n💰 **ShopeePay:** ${ewallet.shopeepay}\\n\\n📱 **QRIS:** ${data.masjid.rekening.qris}\\n\\n💎 **KATEGORI DONASI**\\n🕌 Operasional (Rp 50jt/bulan)\\n📚 Pendidikan (Rp 30jt/bulan)\\n🤝 Sosial (Rp 25jt/bulan)\\n🏗️ Pembangunan (Rp 100jt/tahun)\\n\\n📊 **ZAKAT CALCULATOR**\\n💰 Zakat Mal: 2.5% dari Rp 81jt+\\n🌾 Zakat Profesi: 2.5% dari gaji Rp 7jt+\\n\\n📞 **Konfirmasi:** ${data.masjid.info.whatsapp}\\n🤲 *Jazakumullahu khairan*`;\n  },\n  \n  program_sosial: () => `🤝 *PROGRAM SOSIAL*\\n📍 ${data.masjid.info.nama}\\n\\n👶 **SANTUNAN ANAK YATIM**\\n📅 Setiap tanggal 10\\n👥 250 anak\\n💰 Rp 500.000/anak/bulan\\n\\n👵 **BANTUAN LANSIA**\\n📅 Setiap tanggal 15\\n👥 150 lansia\\n💰 Rp 300.000/orang/bulan\\n\\n🍽️ **DAPUR UMUM**\\n📅 Senin, Rabu, Jumat\\n🕐 11:00-13:00\\n👥 300 porsi/hari\\n\\n🎓 **BEASISWA**\\n📚 SD/MI: Rp 2jt/tahun\\n📚 SMP/MTs: Rp 3jt/tahun\\n📚 SMA/MA: Rp 4jt/tahun\\n📚 Kuliah: Rp 10jt/tahun\\n\\n💼 **UMKM COACHING**\\n📅 Setiap bulan\\n👥 30 peserta\\n💰 Modal: Rp 2jt\\n\\n📞 **Info:** ${data.masjid.info.whatsapp}`,\n  \n  layanan_jenazah: () => `🕊️ *LAYANAN JENAZAH 24/7*\\n📍 ${data.masjid.info.nama}\\n\\nإِنَّا لِلَّهِ وَإِنَّا إِلَيْهِ رَاجِعُونَ\\n\\n📋 **TIM JENAZAH SIAGA**\\n🔹 Koordinator: H. Bambang (+62-815-1234-5678)\\n🔹 Tim Pemandian Pria: Ustadz Ahmad (+62-816-1111-2222)\\n🔹 Tim Pemandian Wanita: Hj. Siti (+62-816-3333-4444)\\n\\n📦 **LAYANAN LENGKAP:**\\n✅ Pemandian jenazah\\n✅ Kafan berkualitas\\n✅ Ambulans 2 unit\\n✅ Prosesi pemakaman\\n✅ Tahlilan 3,7,40,100 hari\\n\\n💰 **DONASI SUKARELA**\\n🏦 BCA: ${data.masjid.rekening.banks.bca.no}\\n📱 DANA: ${data.masjid.rekening.ewallet.dana}\\n\\n🚨 **HOTLINE 24 JAM:** ${data.masjid.info.whatsapp}\\n🤲 *Semoga diterima Allah SWT*`,\n  \n  info_masjid: () => {\n    const masjid = data.masjid;\n    return `🕌 *${masjid.info.nama.toUpperCase()}*\\n\\n📍 **ALAMAT**\\n${masjid.info.alamat}\\n\\n📊 **PROFIL**\\n📅 Berdiri: ${masjid.info.established}\\n👥 Kapasitas: ${masjid.info.capacity} jamaah\\n\\n📞 **KONTAK**\\n📱 WhatsApp: ${masjid.info.whatsapp}\\n📧 Email: ${masjid.info.email}\\n🌐 Website: ${masjid.info.website}\\n\\n🏢 **FASILITAS**\\n🕌 Masjid ber-AC 2000 jamaah\\n🚿 Tempat wudhu pria/wanita\\n🚻 Toilet modern + difabel\\n🅿️ Parkir 500 motor, 200 mobil\\n📚 Perpustakaan 5000+ buku\\n🏫 8 ruang kelas ber-AC\\n🍽️ Dapur & aula 500 orang\\n\\n🕐 **JAM OPERASIONAL**\\nIbadah: 24 jam\\nAdmin: 08:00-16:00 WIB\\n\\n🎯 **VISI**\\nPusat ibadah & dakwah terdepan\\n\\n📋 **MISI**\\n• Melayani umat\\n• Pendidikan Islam\\n• Ekonomi syariah\\n• Kepedulian sosial`;\n  },\n  \n  live_streaming: () => `📺 *LIVE STREAMING*\\n📍 ${data.masjid.info.nama}\\n\\n📱 **PLATFORM:**\\n• YouTube: Masjid Al-Ikhlas TV\\n• Facebook: @MasjidAlIkhlas\\n• Instagram: @masjidalukhlas\\n• Website: ${data.masjid.info.website}/live\\n\\n🕌 **JADWAL STREAMING:**\\n🌅 Subuh: 04:30-05:30\\n☀️ Dzuhur: 12:15-12:45\\n🌙 Magrib: 18:45-19:15\\n🕌 Jumat: 11:30-13:00 (Full)\\n\\n📚 **KAJIAN LIVE:**\\n🕗 Senin: Tafsir Al-Quran\\n🕗 Rabu: Fiqh Muamalah\\n🕗 Sabtu: Kajian Wanita\\n\\n🎥 **FITUR:**\\n✅ HD Quality (1080p)\\n✅ Audio jernih\\n✅ Interactive chat\\n✅ Recording tersedia\\n\\n📊 **STATS:**\\n👥 1000+ viewers rata-rata\\n💬 Active community\\n\\n🔔 Subscribe & bell notification\\n📱 Info: ${data.masjid.info.whatsapp}`,\n  \n  salam_greeting: () => {\n    const timeGreeting = () => {\n      const hour = moment().hour();\n      if (hour < 6) return 'dini hari';\n      if (hour < 11) return 'pagi';\n      if (hour < 15) return 'siang';\n      if (hour < 18) return 'sore';\n      return 'malam';\n    };\n    \n    return `وَعَلَيْكُمُ السَّلَامُ وَرَحْمَةُ اللَّهِ وَبَرَكَاتُهُ\\n\\n*Wa'alaikumussalam warahmatullahi wabarakatuh*\\n\\nSelamat ${timeGreeting()} dan selamat datang di\\n🕌 **${data.masjid.info.nama}**\\n\\n📱 **MENU LAYANAN:**\\n\\n🕌 **IBADAH & SPIRITUAL**\\n1️⃣ Jadwal Shalat\\n2️⃣ Arah Kiblat\\n3️⃣ Doa & Dzikir\\n4️⃣ Ayat Al-Quran\\n5️⃣ Hadits Nabi\\n\\n📚 **PENDIDIKAN**\\n6️⃣ Kajian & Pengajian\\n7️⃣ TPQ & Tahfidz\\n8️⃣ Konsultasi Syariah\\n\\n🤝 **LAYANAN SOSIAL**\\n9️⃣ Donasi & Zakat\\n🔟 Program Sosial\\n1️⃣1️⃣ Layanan Jenazah\\n\\n ℹ️ **INFORMASI**\\n1️⃣2️⃣ Info Masjid\\n1️⃣3️⃣ Live Streaming\\n1️⃣4️⃣ Chat AI\\n\\n💬 Ketik nama layanan atau chat langsung\\n🤖 AI Assistant siap 24/7!\\n\\n🕐 ${moment().format('HH:mm')} WIB - ${moment().format('dddd, DD/MM/YYYY')}`;\n  }\n};\n\nconst template = serviceTemplates[data.intent];\nif (!template) {\n  return [{\n    json: {\n      ...data,\n      response: `❌ Service \"${data.intent}\" belum tersedia.\\n\\nKetik \"menu\" untuk melihat layanan atau chat langsung dengan AI.`,\n      response_type: 'TEMPLATE_NOT_FOUND'\n    }\n  }];\n}\n\nconst response = template();\n\nreturn [{\n  json: {\n    ...data,\n    response: response,\n    response_type: 'SERVICE_TEMPLATE'\n  }\n}];"
      },
      "id": "5",
      "name": "📋 Service Templates",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [950, 500]
    },
    {
      "parameters": {
        "url": "https://api.fonnte.com/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "YOUR_WHATSAPP_API_KEY"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "target",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.response }}"
            },
            {
              "name": "countryCode",
              "value": "62"
            }
          ]
        }
      },
      "id": "6",
      "name": "📤 WhatsApp Sender",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "url": "={{ $json.config.apis.supabase_url }}/rest/v1/chat_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $json.config.apis.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.config.apis.supabase_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_phone",
              "value": "={{ $json.phone }}"
            },
            {
              "name": "intent",
              "value": "={{ $json.intent }}"
            },
            {
              "name": "confidence",
              "value": "={{ $json.confidence || 0 }}"
            },
            {
              "name": "response_type",
              "value": "={{ $json.response_type }}"
            },
            {
              "name": "processing_time",
              "value": "={{ $json.processing_time }}"
            },
            {
              "name": "timestamp",
              "value": "={{ $json.timestamp }}"
            },
            {
              "name": "day_name",
              "value": "={{ $json.day_name }}"
            },
            {
              "name": "ai_model",
              "value": "={{ $json.ai_model || 'none' }}"
            },
            {
              "name": "ai_tokens",
              "value": "={{ $json.ai_tokens || 0 }}"
            }
          ]
        }
      },
      "id": "7",
      "name": "📊 Supabase Logger",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1200, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"message\": \"Replit workflow completed\",\n  \"data\": {\n    \"phone\": $json.phone,\n    \"intent\": $json.intent,\n    \"confidence\": $json.confidence || 0,\n    \"response_type\": $json.response_type,\n    \"processing_time\": $json.processing_time + \"ms\",\n    \"timestamp\": $json.timestamp,\n    \"hosted_on\": \"replit\"\n  }\n} }}"
      },
      "id": "8",
      "name": "✅ Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1450, 450]
    }
  ],
  "connections": {
    "📱 WhatsApp Gateway": {
      "main": [
        [
          {
            "node": "🧠 Smart Processor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🧠 Smart Processor": {
      "main": [
        [
          {
            "node": "🤖 Need AI?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🤖 Need AI?": {
      "main": [
        [
          {
            "node": "🤖 AI Engine",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "📋 Service Templates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🤖 AI Engine": {
      "main": [
        [
          {
            "node": "📤 WhatsApp Sender",
            "type": "main",
            "index": 0
          },
          {
            "node": "📊 Supabase Logger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📋 Service Templates": {
      "main": [
        [
          {
            "node": "📤 WhatsApp Sender",
            "type": "main",
            "index": 0
          },
          {
            "node": "📊 Supabase Logger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📤 WhatsApp Sender": {
      "main": [
        [
          {
            "node": "✅ Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📊 Supabase Logger": {
      "main": [
        [
          {
            "node": "✅ Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "2.0",
  "id": "masjid-ai-replit-workflow",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "tags": [
    {
      "id": "replit-ready",
      "name": "Replit Ready"
    },
    {
      "id": "masjid-ai",
      "name": "Masjid AI"
    },
    {
      "id": "optimized",
      "name": "Optimized"
    }
  ]
}