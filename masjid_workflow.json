{
  "workflow": {
    "name": "Masjid AI Assistant Workflow",
    "version": "1.0.0",
    "description": "Workflow agent AI untuk layanan masjid dengan integrasi WhatsApp",
    "trigger": {
      "type": "webhook",
      "source": "whatsapp",
      "endpoint": "/webhook/whatsapp",
      "method": "POST",
      "headers": {
        "content-type": "application/json",
        "authorization": "Bearer {{WHATSAPP_TOKEN}}"
      }
    },
    "nodes": {
      "input_processor": {
        "id": "node_001",
        "type": "processor",
        "name": "WhatsApp Message Processor",
        "description": "Memproses pesan masuk dari WhatsApp",
        "config": {
          "extract_fields": ["phone_number", "message_text", "timestamp", "message_type"],
          "validation": {
            "required": ["phone_number", "message_text"],
            "phone_format": "^\\+62[0-9]{10,13}$"
          }
        },
        "next_nodes": ["intent_classifier"]
      },
      "intent_classifier": {
        "id": "node_002",
        "type": "ai_classifier",
        "name": "Intent Classification",
        "description": "Mengklasifikasi intent dari pesan pengguna",
        "config": {
          "model": "gpt-3.5-turbo",
          "intents": {
            "jadwal_shalat": {
              "keywords": ["jadwal shalat", "waktu shalat", "adzan", "magrib", "subuh", "dzuhur", "ashar", "isya"],
              "patterns": ["kapan.*shalat", "jam.*shalat", "waktu.*adzan"]
            },
            "kajian_info": {
              "keywords": ["kajian", "pengajian", "ceramah", "ustadz", "kuliah"],
              "patterns": ["kajian.*hari", "pengajian.*minggu", "ustadz.*ceramah"]
            },
            "donasi": {
              "keywords": ["donasi", "infaq", "sedekah", "zakat", "bantuan"],
              "patterns": ["mau.*donasi", "cara.*infaq", "transfer.*zakat"]
            },
            "acara_masjid": {
              "keywords": ["acara", "event", "kegiatan", "agenda", "program"],
              "patterns": ["acara.*apa", "kegiatan.*minggu", "agenda.*bulan"]
            },
            "informasi_umum": {
              "keywords": ["info", "alamat", "kontak", "lokasi", "jam buka"],
              "patterns": ["dimana.*masjid", "alamat.*masjid", "kontak.*takmir"]
            },
            "daftar_nikah": {
              "keywords": ["nikah", "menikah", "akad", "daftar nikah", "syarat nikah"],
              "patterns": ["mau.*nikah", "daftar.*akad", "syarat.*menikah"]
            }
          },
          "default_intent": "informasi_umum",
          "confidence_threshold": 0.7
        },
        "next_nodes": {
          "jadwal_shalat": ["prayer_schedule_handler"],
          "kajian_info": ["kajian_handler"],
          "donasi": ["donation_handler"],
          "acara_masjid": ["event_handler"],
          "informasi_umum": ["general_info_handler"],
          "daftar_nikah": ["marriage_handler"],
          "default": ["fallback_handler"]
        }
      },
      "prayer_schedule_handler": {
        "id": "node_003",
        "type": "data_processor",
        "name": "Prayer Schedule Handler",
        "description": "Menangani permintaan jadwal shalat",
        "config": {
          "data_source": "prayer_times_api",
          "location": {
            "city": "{{USER_CITY}}",
            "country": "Indonesia",
            "timezone": "Asia/Jakarta"
          },
          "response_template": "ğŸ•Œ *Jadwal Shalat Hari Ini*\n\nğŸŒ… Subuh: {{fajr}}\nâ˜€ï¸ Dzuhur: {{dhuhr}}\nğŸŒ¤ï¸ Ashar: {{asr}}\nğŸŒ… Magrib: {{maghrib}}\nğŸŒ™ Isya: {{isha}}\n\nSemoga bermanfaat! ğŸ¤²"
        },
        "next_nodes": ["response_formatter"]
      },
      "kajian_handler": {
        "id": "node_004",
        "type": "database_query",
        "name": "Kajian Information Handler",
        "description": "Menangani informasi kajian dan pengajian",
        "config": {
          "database": "masjid_db",
          "table": "kajian_schedule",
          "query_type": "select",
          "filters": {
            "active": true,
            "date": ">=TODAY"
          },
          "response_template": "ğŸ“š *Jadwal Kajian Masjid*\n\n{{#each kajian}}\nğŸ“… {{tanggal}}\nğŸ• {{waktu}}\nğŸ‘¨â€ğŸ« Ustadz {{ustadz}}\nğŸ“– Tema: {{tema}}\nğŸ“ {{lokasi}}\n\n{{/each}}\nBarakallahu fiikum! ğŸ¤²"
        },
        "next_nodes": ["response_formatter"]
      },
      "donation_handler": {
        "id": "node_005",
        "type": "payment_processor",
        "name": "Donation Handler",
        "description": "Menangani proses donasi dan infaq",
        "config": {
          "payment_methods": ["bank_transfer", "e_wallet", "qris"],
          "bank_accounts": [
            {
              "bank": "BCA",
              "account_number": "1234567890",
              "account_name": "Masjid Al-Ikhlas"
            },
            {
              "bank": "Mandiri",
              "account_number": "0987654321",
              "account_name": "Masjid Al-Ikhlas"
            }
          ],
          "qris_code": "{{QRIS_IMAGE_URL}}",
          "response_template": "ğŸ’° *Donasi & Infaq Masjid*\n\nğŸ¦ *Transfer Bank:*\n{{#each bank_accounts}}\nğŸ§ {{bank}}: {{account_number}}\na.n {{account_name}}\n\n{{/each}}ğŸ“± *QRIS:*\n{{qris_code}}\n\nJazakallahu khairan atas kebaikan Anda! ğŸ¤²\n\nKonfirmasi donasi ke: {{ADMIN_PHONE}}"
        },
        "next_nodes": ["response_formatter"]
      },
      "event_handler": {
        "id": "node_006",
        "type": "calendar_processor",
        "name": "Event Information Handler",
        "description": "Menangani informasi acara dan kegiatan masjid",
        "config": {
          "calendar_source": "masjid_calendar",
          "time_range": "30_days",
          "event_types": ["kajian", "pengajian", "acara_khusus", "pelatihan", "bakti_sosial"],
          "response_template": "ğŸ“… *Agenda Kegiatan Masjid*\n\n{{#each events}}\nğŸ“‹ {{nama_acara}}\nğŸ“… {{tanggal}}\nğŸ• {{waktu}}\nğŸ“ {{tempat}}\nğŸ‘¥ {{peserta}}\nğŸ’µ {{biaya}}\n\n{{/each}}\nDaftarkan diri Anda! ğŸ“"
        },
        "next_nodes": ["response_formatter"]
      },
      "general_info_handler": {
        "id": "node_007",
        "type": "static_responder",
        "name": "General Information Handler",
        "description": "Menangani informasi umum masjid",
        "config": {
          "masjid_info": {
            "nama": "Masjid Al-Ikhlas",
            "alamat": "Jl. Raya Masjid No. 123, Jakarta Selatan",
            "telefon": "+62-21-12345678",
            "email": "info@masjidalukhlas.id",
            "jam_buka": "04:30 - 22:00 WIB",
            "fasilitas": ["Tempat Wudhu", "Parkir", "AC", "Sound System", "Perpustakaan"],
            "takmir": "Bapak Ahmad Suryadi",
            "kontak_takmir": "+62-812-3456-7890"
          },
          "response_template": "ğŸ•Œ *Masjid {{nama}}*\n\nğŸ“ Alamat: {{alamat}}\nâ˜ï¸ Telepon: {{telefon}}\nğŸ“§ Email: {{email}}\nğŸ• Jam Buka: {{jam_buka}}\n\nğŸ¢ *Fasilitas:*\n{{#each fasilitas}}\nâœ… {{this}}\n{{/each}}\n\nğŸ‘¨â€ğŸ’¼ Takmir: {{takmir}}\nğŸ“± Kontak: {{kontak_takmir}}\n\nSelamat datang di masjid kami! ğŸ¤²"
        },
        "next_nodes": ["response_formatter"]
      },
      "marriage_handler": {
        "id": "node_008",
        "type": "form_processor",
        "name": "Marriage Registration Handler",
        "description": "Menangani pendaftaran nikah",
        "config": {
          "required_documents": [
            "KTP Calon Pengantin",
            "Surat Keterangan Belum Menikah",
            "Surat Persetujuan Orang Tua",
            "Pas Foto 3x4 (4 lembar)",
            "Surat Keterangan Sehat"
          ],
          "process_steps": [
            "Konsultasi pra-nikah",
            "Melengkapi berkas",
            "Verifikasi dokumen",
            "Penentuan jadwal akad",
            "Pelaksanaan akad nikah"
          ],
          "contact_person": "Ustadz Ahmad (WA: +62-812-3456-7890)",
          "response_template": "ğŸ’’ *Pendaftaran Nikah - Masjid Al-Ikhlas*\n\nğŸ“‹ *Dokumen yang diperlukan:*\n{{#each required_documents}}\nğŸ“„ {{this}}\n{{/each}}\n\nğŸ“ *Tahapan Proses:*\n{{#each process_steps}}\n{{@index}}. {{this}}\n{{/each}}\n\nğŸ‘¨â€ğŸ« Narahubung: {{contact_person}}\n\nSemoga Allah mudahkan urusan Anda! ğŸ¤²"
        },
        "next_nodes": ["response_formatter"]
      },
      "fallback_handler": {
        "id": "node_009",
        "type": "ai_responder",
        "name": "Fallback Handler",
        "description": "Menangani pesan yang tidak dikenali",
        "config": {
          "model": "gpt-3.5-turbo",
          "context": "Anda adalah asisten AI untuk Masjid Al-Ikhlas. Berikan respons yang membantu dan islami.",
          "fallback_responses": [
            "Maaf, saya belum memahami maksud Anda. Silakan ketik:\n\nğŸ“ *Menu Layanan:*\n1ï¸âƒ£ Jadwal Shalat\n2ï¸âƒ£ Info Kajian\n3ï¸âƒ£ Donasi\n4ï¸âƒ£ Acara Masjid\n5ï¸âƒ£ Info Umum\n6ï¸âƒ£ Daftar Nikah\n\nAtau silakan bertanya dengan kalimat yang lebih jelas. Jazakallahu khairan! ğŸ¤²"
          ],
          "enable_ai_response": true,
          "max_tokens": 150
        },
        "next_nodes": ["response_formatter"]
      },
      "response_formatter": {
        "id": "node_010",
        "type": "formatter",
        "name": "Response Formatter",
        "description": "Memformat respons akhir untuk dikirim ke WhatsApp",
        "config": {
          "output_format": "whatsapp_markdown",
          "add_signature": true,
          "signature_text": "\n\n---\nğŸ•Œ *Masjid Al-Ikhlas*\nğŸ“± Bot Assistant v1.0",
          "emoji_enhancement": true,
          "max_length": 4000
        },
        "next_nodes": ["whatsapp_sender"]
      },
      "whatsapp_sender": {
        "id": "node_011",
        "type": "api_sender",
        "name": "WhatsApp Sender",
        "description": "Mengirim respons ke WhatsApp",
        "config": {
          "api_endpoint": "{{WHATSAPP_API_URL}}/send-message",
          "method": "POST",
          "headers": {
            "Authorization": "Bearer {{WHATSAPP_TOKEN}}",
            "Content-Type": "application/json"
          },
          "payload_template": {
            "phone": "{{user_phone}}",
            "message": "{{formatted_response}}",
            "type": "text"
          },
          "retry_count": 3,
          "timeout": 30
        },
        "next_nodes": ["logger"]
      },
      "logger": {
        "id": "node_012",
        "type": "logger",
        "name": "Activity Logger",
        "description": "Mencatat aktivitas workflow",
        "config": {
          "log_level": "info",
          "log_fields": ["timestamp", "user_phone", "intent", "response_status", "processing_time"],
          "storage": "file",
          "log_file": "logs/masjid_workflow.log",
          "rotation": "daily",
          "retention_days": 30
        },
        "next_nodes": []
      }
    },
    "environment": {
      "development": {
        "WHATSAPP_API_URL": "https://api.whatsapp.dev",
        "WHATSAPP_TOKEN": "dev_token_12345",
        "DATABASE_URL": "sqlite:///masjid_dev.db",
        "LOG_LEVEL": "debug"
      },
      "production": {
        "WHATSAPP_API_URL": "https://graph.facebook.com/v18.0",
        "WHATSAPP_TOKEN": "{{PROD_WHATSAPP_TOKEN}}",
        "DATABASE_URL": "postgresql://user:pass@localhost/masjid_prod",
        "LOG_LEVEL": "info"
      }
    },
    "error_handling": {
      "retry_policy": {
        "max_retries": 3,
        "backoff_strategy": "exponential",
        "base_delay": 1
      },
      "fallback_actions": {
        "api_timeout": "send_error_message",
        "database_error": "use_cached_data",
        "ai_service_down": "use_static_responses"
      },
      "error_responses": {
        "general_error": "Maaf, terjadi kendala teknis. Silakan coba lagi dalam beberapa saat. Barakallahu fiikum! ğŸ¤²",
        "timeout_error": "Permintaan membutuhkan waktu lebih lama. Mohon tunggu sebentar ya...",
        "invalid_input": "Format pesan belum sesuai. Silakan coba lagi dengan format yang benar."
      }
    },
    "monitoring": {
      "metrics": {
        "message_count": "counter",
        "response_time": "histogram",
        "error_rate": "gauge",
        "intent_accuracy": "gauge"
      },
      "alerts": {
        "high_error_rate": {
          "threshold": 0.1,
          "action": "send_notification"
        },
        "slow_response": {
          "threshold": 5000,
          "action": "log_warning"
        }
      }
    },
    "security": {
      "webhook_verification": true,
      "rate_limiting": {
        "requests_per_minute": 30,
        "burst_allowance": 10
      },
      "input_sanitization": true,
      "output_filtering": true
    }
  }
}